<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PDF Question Generator (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .correct-answer {
            background-color: #d1fae5; /* A light green background */
            border-left: 4px solid #10b981; /* A solid green border */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Advanced AI PDF Question Generator</h1>
            <p class="text-md text-gray-600 mt-2">Let AI read the PDF page and generate a new question for you.</p>
        </header>

        <main class="bg-white p-6 rounded-2xl shadow-lg space-y-6">
            <div>
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">1. Setup</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="pdf-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload PDF File</label>
                        <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                    </div>
                    <div>
                        <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1">Enter Google AI API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your API key here" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">2. Generate Question</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div>
                        <label for="question-number-input" class="block text-sm font-medium text-gray-700 mb-1">Enter Question Number</label>
                        <input type="number" id="question-number-input" placeholder="e.g., 5" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="generate-btn" class="w-full bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:bg-gray-400">
                        Generate MCQ with AI
                    </button>
                </div>
            </div>

            <div id="status-section" class="text-center my-4 hidden">
                <div class="flex items-center justify-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mr-3"></div>
                    <p id="status-message" class="text-lg font-medium text-gray-700"></p>
                </div>
            </div>

            <div id="result-section" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">AI Generated Result</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    <div id="original-page-display" class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                         <h3 class="text-lg font-semibold mb-2 text-gray-800">Original Page</h3>
                         <img id="page-image" class="w-full rounded-md shadow-sm" alt="PDF Page Image">
                    </div>
                    <div id="ai-result-box" class="p-4 bg-blue-50 rounded-lg border border-blue-200 text-gray-800 prose max-w-none">
                        </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Built with PDF.js, Tailwind CSS, and the Google Gemini API.</p>
        </footer>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        const pdfUploadInput = document.getElementById('pdf-upload');
        const apiKeyInput = document.getElementById('api-key');
        const questionNumberInput = document.getElementById('question-number-input');
        const generateBtn = document.getElementById('generate-btn');
        const statusSection = document.getElementById('status-section');
        const statusMessage = document.getElementById('status-message');
        const resultSection = document.getElementById('result-section');
        const pageImage = document.getElementById('page-image');
        const aiResultBox = document.getElementById('ai-result-box');

        let pdfFile = null;
        const apiCache = {}; 

        pdfUploadInput.addEventListener('change', (event) => {
            pdfFile = event.target.files[0];
        });

        async function getPageAsImage(pdfDoc, pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.2 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            return canvas.toDataURL('image/jpeg', 0.9);
        }

        async function findPageForQuestion(pdfDoc, questionNumber) {
            const questionPattern = new RegExp(`(^|\\n)\\s*${questionNumber}\\.`);
            for (let i = pdfDoc.numPages; i >= 1; i--) {
                const page = await pdfDoc.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join('\n');
                if (questionPattern.test(pageText)) {
                    const originalQuestionText = pageText.split(questionPattern)[2].trim().split('\n')[0];
                    return { pageNum: i, originalQuestionText: originalQuestionText };
                }
            }
            return null;
        }

        generateBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            const questionNumber = questionNumberInput.value;

            if (!pdfFile || !apiKey || !questionNumber) {
                alert('Please upload a PDF, enter an API key, and specify a question number.');
                return;
            }

            statusSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            generateBtn.disabled = true;

            try {
                const cacheKey = `${pdfFile.name}-${questionNumber}`;
                if (apiCache[cacheKey]) {
                    statusMessage.textContent = 'Loading from cache...';
                    statusSection.classList.remove('hidden');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    displayMcq(apiCache[cacheKey]);
                    pageImage.src = apiCache[cacheKey].pageImage;
                    resultSection.classList.remove('hidden');
                    return;
                }

                statusMessage.textContent = 'Loading PDF...';
                const typedarray = new Uint8Array(await pdfFile.arrayBuffer());
                const pdfDoc = await pdfjsLib.getDocument({ data: typedarray }).promise;

                statusMessage.textContent = `Finding page for question #${questionNumber}...`;
                const pageInfo = await findPageForQuestion(pdfDoc, questionNumber);

                if (!pageInfo) {
                    throw new Error(`Could not find question number ${questionNumber} in the PDF.`);
                }

                statusMessage.textContent = `Rendering page ${pageInfo.pageNum}...`;
                const imageDataUrl = await getPageAsImage(pdfDoc, pageInfo.pageNum);
                pageImage.src = imageDataUrl;

                statusMessage.textContent = 'Asking AI to generate a new MCQ... ðŸ¤–';
                const mcqData = await callGeminiApi(apiKey, imageDataUrl, pageInfo.originalQuestionText);

                mcqData.pageImage = imageDataUrl;
                apiCache[cacheKey] = mcqData;

                displayMcq(mcqData);
                resultSection.classList.remove('hidden');

            } catch (error) {
                console.error('Generation failed:', error);
                alert(`An error occurred: ${error.message}`);
            } finally {
                statusSection.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });

        async function callGeminiApi(apiKey, imageDataUrl, originalQuestionText) {
            const model = 'gemini-1.5-flash';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            // --- NEW, MORE DETAILED PROMPT ---
            const prompt = `You are an expert in creating educational material for young students.
            
1.  **Analyze the context:** The user has provided an image of a PDF page and the original question text from that page.
    * **Original Question Text:** "${originalQuestionText}"
    * From this, understand the topic (e.g., telling time, simple counting, addition) and the difficulty level (e.g., for a 1st grader).

2.  **Your Task:** Create one new multiple-choice question (MCQ) that is **on the same topic and of a similar difficulty level**. Use the visual information from the image if relevant.

3.  **Format your response:** Your response MUST be a valid JSON object with the following structure and nothing else:
{
  "question": "The text of the new question",
  "options": {
    "A": "Option A text",
    "B": "Option B text",
    "C": "Option C text",
    "D": "Option D text"
  },
  "correct_answer": "A"
}
`;

            const imageBase64 = imageDataUrl.split(',')[1];
            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: 'image/jpeg', data: imageBase64 } }
                    ]
                }]
            };

            let response;
            const maxRetries = 3;
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    statusMessage.textContent = `Asking AI... (Attempt ${attempt + 1})`;
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        break;
                    }

                    if (response.status === 503) {
                        throw new Error("The model is overloaded. Retrying...");
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                    }
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        throw new Error("The model is overloaded. Please try again later.");
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    statusMessage.textContent = `${error.message} Waiting ${delay / 1000}s.`;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            const data = await response.json();
            const rawText = data.candidates[0].content.parts[0].text;
            
            const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Failed to parse AI response as JSON:", jsonText);
                throw new Error("The AI returned a response that was not in the correct JSON format.");
            }
        }
        
        function displayMcq(mcqData) {
            let html = `<p class="font-semibold text-lg mb-4">${mcqData.question}</p>`;
            html += `<ul class="space-y-2">`;
            
            for (const key in mcqData.options) {
                const isCorrect = key === mcqData.correct_answer;
                const optionClass = isCorrect ? 'correct-answer' : '';
                html += `<li class="p-2 rounded-md ${optionClass}"><strong>${key})</strong> ${mcqData.options[key]}</li>`;
            }
            
            html += `</ul>`;
            aiResultBox.innerHTML = html;
        }

    </script>
</body>
</html>
